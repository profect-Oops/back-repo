<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AlertServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oops</a> &gt; <a href="index.source.html" class="el_package">org.oops.api.alert.service</a> &gt; <span class="el_source">AlertServiceImpl.java</span></div><h1>AlertServiceImpl.java</h1><pre class="source lang-java linenums">package org.oops.api.alert.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.persistence.EntityNotFoundException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.oops.api.alert.dto.CreateAlertDTO;
import org.oops.api.alert.dto.GetAlertResponseDTO;
import org.oops.api.alert.dto.UpdateAlertDTO;
import org.oops.domain.alert.Alert;
import org.oops.domain.alert.AlertRepository;
import org.oops.domain.coin.Coin;
import org.oops.domain.coin.CoinRepository;
import org.oops.domain.user.User;
import org.oops.domain.user.UserRepository;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.concurrent.TimeUnit;

<span class="nc" id="L24">@Slf4j</span>
@Service
@Transactional
<span class="nc" id="L27">@RequiredArgsConstructor</span>
public class AlertServiceImpl implements AlertService {

    private final AlertRepository alertRepository;
    private final UserRepository userRepository;
    private final CoinRepository coinRepository;
    private final StringRedisTemplate redisTemplate;
<span class="nc" id="L34">    private final ObjectMapper objectMapper = new ObjectMapper();</span>

    //알림 저장
    @Override
    public CreateAlertDTO.CreateAlertResponseDTO saveAlert(String email, CreateAlertDTO.CreateAlertRequestDTO request){
<span class="nc" id="L39">        User user = userRepository.findByEmail(email).orElseThrow(</span>
<span class="nc" id="L40">                () -&gt; new EntityNotFoundException(&quot;해당 유저가 없습니다.&quot;)</span>
        );

<span class="nc" id="L43">        Coin coin = coinRepository.findByName(request.getCoinName()).orElseThrow(</span>
<span class="nc" id="L44">                () -&gt; new EntityNotFoundException(&quot;해당 코인이 없습니다.&quot;)</span>
        );

<span class="nc" id="L47">        log.info(&quot;서비스 확인 Inserting alert: alertActive = {}, alertPrice = {}, coinId = {}, userId = {}&quot;,</span>
<span class="nc" id="L48">                request.getAlertActive(), request.getAlertPrice(), coin.getCoinId(), user.getUserId());</span>


<span class="nc" id="L51">        Alert alert = alertRepository.save(</span>
<span class="nc" id="L52">                Alert.fromDTO(</span>
<span class="nc" id="L53">                        request.getAlertPrice(),</span>
<span class="nc" id="L54">                        request.getAlertActive(),</span>
                        coin,
                        user,
<span class="nc" id="L57">                        request.getCoinName(),</span>
<span class="nc" id="L58">                        coin.getTicker(),</span>
                        email,
<span class="nc" id="L60">                        request.getAlertCondition()</span>
                )
        );

        // 알림이 생성되었으므로 Redis 캐시 삭제
<span class="nc" id="L65">        updateCache(alert.getCoinTicker());</span>

<span class="nc" id="L67">        return CreateAlertDTO.CreateAlertResponseDTO.fromEntity(alert);</span>
    }

    //내 알림 리스트 보기
    @Override
    @Transactional(readOnly = true)
    public List&lt;GetAlertResponseDTO&gt; getAlertByUserId(Long userId){
<span class="nc" id="L74">        return alertRepository.findByUserId_UserId(userId).stream().map(GetAlertResponseDTO::fromEntity).toList();</span>
    }

    //알림 하나 상세보기
    @Override
    @Transactional(readOnly = true)
    public GetAlertResponseDTO getAlertByAlertId(Long alertId){
<span class="nc" id="L81">        Alert alert = alertRepository.findById(alertId).orElseThrow(</span>
<span class="nc" id="L82">                () -&gt; new EntityNotFoundException(&quot;해당되는 알림이 없습니다.&quot;)</span>
        );
<span class="nc" id="L84">        return GetAlertResponseDTO.fromEntity(alert);</span>
    }

    //알림 활성화 여부 수정
    @Override
    @Transactional
    public void updateAlertStatus(Long alertId, Boolean alertActive){
        // 알림 ID로 해당 알림 조회
<span class="nc" id="L92">        Alert alert = alertRepository.findById(alertId).orElse(null);</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (alert == null) {</span>
<span class="nc" id="L95">            throw new IllegalArgumentException(&quot;알림을 찾을 수 없습니다.&quot;);</span>
        }

        // alertActive 값 변경
<span class="nc" id="L99">        alert.updateAlertActive(alertActive);</span>

        // 알림 상태 업데이트
<span class="nc" id="L102">        alertRepository.save(alert);</span>

        // 알림이 변경되었으므로 Redis 캐시 삭제
<span class="nc" id="L105">        String cacheKey = &quot;alert_list:&quot; + alert.getCoinTicker();</span>
<span class="nc" id="L106">        redisTemplate.delete(cacheKey);</span>

        // 알림이 활성화된 경우에만 새로운 데이터를 즉시 캐싱
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (alertActive) {</span>
<span class="nc" id="L110">            List&lt;Alert&gt; alerts = alertRepository.findByCoinTickerAndAlertActiveTrue(alert.getCoinTicker());</span>
            try {
<span class="nc" id="L112">                redisTemplate.opsForValue().set(cacheKey, objectMapper.writeValueAsString(alerts), 5, TimeUnit.MINUTES);</span>
<span class="nc" id="L113">                log.info(&quot;✅ Redis 캐시 새롭게 갱신: {}&quot;, cacheKey);</span>
<span class="nc" id="L114">            } catch (Exception e) {</span>
<span class="nc" id="L115">                log.error(&quot;❌ Redis 캐싱 갱신 중 오류 발생&quot;, e);</span>
<span class="nc" id="L116">            }</span>
        }
<span class="nc" id="L118">    }</span>

    //알림 조건 수정
    @Override
    @Transactional
    public void updateAlertCondition(Long alertId, String alertCondition){
        // 알림 ID로 해당 알림 조회
<span class="nc" id="L125">        Alert alert = alertRepository.findById(alertId).orElse(null);</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (alert == null) {</span>
<span class="nc" id="L128">            throw new IllegalArgumentException(&quot;알림을 찾을 수 없습니다.&quot;);</span>
        }

        // condition 값 변경
<span class="nc" id="L132">        alert.updateCondition(alertCondition);</span>

        // 알림 상태 업데이트
<span class="nc" id="L135">        alertRepository.save(alert);</span>

        // 알림이 변경되었으므로 Redis 캐시 삭제
<span class="nc" id="L138">        String cacheKey = &quot;alert_list:&quot; + alert.getCoinTicker();</span>
<span class="nc" id="L139">        redisTemplate.delete(cacheKey);</span>

        //새로운 데이터를 즉시 캐싱
<span class="nc" id="L142">        List&lt;Alert&gt; alerts = alertRepository.findByCoinTickerAndAlertActiveTrue(alert.getCoinTicker());</span>
        try {
<span class="nc" id="L144">            redisTemplate.opsForValue().set(cacheKey, objectMapper.writeValueAsString(alerts), 5, TimeUnit.MINUTES);</span>
<span class="nc" id="L145">            log.info(&quot;✅ Redis 캐시 새롭게 갱신: {}&quot;, cacheKey);</span>
<span class="nc" id="L146">        } catch (Exception e) {</span>
<span class="nc" id="L147">            log.error(&quot;❌ Redis 캐싱 갱신 중 오류 발생&quot;, e);</span>
<span class="nc" id="L148">        }</span>

<span class="nc" id="L150">    }</span>

    //알림 가격 수정
    @Override
    @Transactional
    public void updateAlertPrice(Long alertId, BigDecimal alertPrice){
        // 알림 ID로 해당 알림 조회
<span class="nc" id="L157">        Alert alert = alertRepository.findById(alertId).orElse(null);</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (alert == null) {</span>
<span class="nc" id="L160">            throw new IllegalArgumentException(&quot;알림을 찾을 수 없습니다.&quot;);</span>
        }

        // alertPrice 값 수정
<span class="nc" id="L164">        alert.updateAlertPrice(alertPrice);</span>

        // 알림 상태 업데이트
<span class="nc" id="L167">        alertRepository.save(alert);</span>

        // Redis 캐시 업데이트
<span class="nc" id="L170">        updateCache(alert.getCoinTicker());</span>
<span class="nc" id="L171">    }</span>


    //알림 삭제
    @Override
    @Transactional
    public void deleteAlertById(Long alertId){
        try{
<span class="nc" id="L179">            alertRepository.deleteById(alertId);</span>
<span class="nc" id="L180">        }catch (IllegalArgumentException ex){</span>
<span class="nc" id="L181">            throw new EntityNotFoundException(&quot;해당 알림이 없습니다.&quot;);</span>
<span class="nc" id="L182">        }catch (Exception ex){</span>
<span class="nc" id="L183">            ex.printStackTrace();</span>
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">    }</span>

    //내 알림의 총 개수 조회
    @Override
    @Transactional(readOnly = true)
    public int getTotalAlertCount(Long userId){
<span class="nc" id="L191">        return alertRepository.countByUserId_UserId(userId);</span>
    }

    //내 알림 중 알림 활성화 된 알림 개수 조회
    @Override
    @Transactional(readOnly = true)
    public int getActiveAlertCount(Long userId){
<span class="nc" id="L198">        return alertRepository.countByUserId_UserIdAndAlertActiveTrue(userId);</span>
    }

    // Redis 캐시 업데이트 메서드 (캐시 삭제 후 새로운 데이터 저장)
    private void updateCache(String coinTicker) {
<span class="nc" id="L203">        String cacheKey = &quot;alert_list:&quot; + coinTicker;</span>
<span class="nc" id="L204">        redisTemplate.delete(cacheKey);</span>

<span class="nc" id="L206">        List&lt;Alert&gt; alerts = alertRepository.findByCoinTickerAndAlertActiveTrue(coinTicker);</span>
        try {
<span class="nc" id="L208">            redisTemplate.opsForValue().set(cacheKey, objectMapper.writeValueAsString(alerts), 5, TimeUnit.MINUTES);</span>
<span class="nc" id="L209">            log.info(&quot;Redis 캐시 새롭게 갱신: {}&quot;, cacheKey);</span>
<span class="nc" id="L210">        } catch (Exception e) {</span>
<span class="nc" id="L211">            log.error(&quot;Redis 캐싱 갱신 중 오류 발생&quot;, e);</span>
<span class="nc" id="L212">        }</span>
<span class="nc" id="L213">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>